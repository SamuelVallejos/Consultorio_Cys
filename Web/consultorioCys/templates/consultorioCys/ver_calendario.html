{% extends 'consultorioCys/base_generic.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center text-primary mb-4"><i class="bi bi-calendar-event me-2"></i> Calendario de Citas</h2>
    <div id="calendar" class="shadow rounded border"></div>
</div>

<!-- Modal para mostrar los detalles del evento -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="eventModalLabel"><i class="bi bi-info-circle me-2"></i> Detalles de la Cita</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-person-circle text-primary me-2" style="font-size: 1.5rem;"></i>
                    <h6 class="mb-0"><strong>Paciente:</strong> <span id="eventTitle"></span></h6>
                </div>
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-clock text-primary me-2" style="font-size: 1.5rem;"></i>
                    <h6 class="mb-0"><strong>Hora:</strong> <span id="eventTime"></span></h6>
                </div>
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-file-earmark-text text-primary me-2" style="font-size: 1.5rem;"></i>
                    <h6 class="mb-0"><strong>Detalles Adicionales:</strong> <span id="eventDetails"></span></h6>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary me-auto" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Cerrar
                </button>
                <a id="iniciarSesion" class="btn btn-primary">
                    <i class="bi bi-person-circle me-1"></i> Ir a paciente
                </a>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar Script -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const eventos = {{ eventos|safe }} || [];

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        themeSystem: 'bootstrap',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: 'Hoy',
            month: 'Mes',
            week: 'Semana',
            day: 'Día'
        },
        slotLabelFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        },
        nowIndicator: true,
        scrollTime: '08:00:00',
        slotDuration: '00:30:00',
        slotLabelInterval: '01:00:00',
        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',
        events: eventos,
        eventClick: function (info) {
            const { title, start, extendedProps } = info.event;
            if (title && start) {
                document.getElementById('eventTitle').innerText = title;
                document.getElementById('eventTime').innerText = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('eventDetails').innerText = extendedProps.details || 'No hay detalles adicionales';

                const rutPaciente = extendedProps.rut_paciente || '';
                const redirigirUrl = `/iniciar_sesion_paciente/${rutPaciente}/`;
                document.getElementById('iniciarSesion').href = redirigirUrl;

                const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
                eventModal.show();
            } else {
                alert('Información del evento no válida.');
            }
        }
    });

    calendar.render();
});
</script>

<!-- Estilos Personalizados para FullCalendar -->
<style>
/* General */
#calendar {
    padding: 20px;
    background-color: #ffffff;
    border-radius: 10px;
}

/* Header */
.fc-toolbar {
    margin-bottom: 15px;
    text-align: center;
}

.fc-toolbar-title {
    font-size: 1.5rem;
    color: #0d6efd;
    font-weight: bold;
}

.fc-button {
    background-color: #0d6efd !important;
    color: #fff !important;
    border: none !important;
    border-radius: 5px !important;
}

.fc-button:hover {
    background-color: #084298 !important;
}

/* Modal */
.modal-content {
    border-radius: 10px;
}

.modal-footer .btn {
    border-radius: 5px;
}

/* Encabezados de columna */
.fc-col-header-cell {
    background-color: #0d6efd !important;
    color: #fff !important;
    font-weight: bold;
    text-align: center;
    padding: 10px;
    border: 1px solid #084298;
    border-radius: 5px 5px 0 0;
}

/* Horas en las vistas de Semana y Día */
.fc-timegrid-slot-label {
    font-weight: bold;
    color: #0d6efd;
    padding: 5px;
    text-align: right;
    border-right: 1px solid #ddd;
}

.fc-timegrid-slot {
    background-color: #f9f9f9;
    border-bottom: 1px solid #ddd;
}

/* Líneas de tiempo */
.fc-now-indicator {
    background-color: #ff0000 !important;
    height: 2px;
}

/* Día actual en vistas de Semana y Día */
.fc-day-today {
    background-color: #e0f3ff !important;
    border: 2px solid #0d6efd;
}

/* Eventos */
.fc-event {
    background-color: #0d6efd !important;
    border: 1px solid #084298 !important;
    color: #fff !important;
    border-radius: 5px;
    padding: 5px;
    text-align: left;
    overflow: hidden;
    white-space: normal;
    line-height: 1.4;
    word-wrap: break-word;
}
</style>
{% endblock %}

<!-- Scripts de Bootstrap y FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.6/locales/es.js"></script>
